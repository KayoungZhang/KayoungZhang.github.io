

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="在Free RTOS中，队列是任务间通信的主要形式。它们可以用于在任务之间、中断和任务之间发送消息。下面来看看队列的相关内容。 队列特性  数据存储（Data Storage）  队列通常用作先进先出（FIFO）缓冲区，其中数据被写入队列的末尾（尾部），并从队列的前端（头部）移除。队列可以容纳有限数量（长度）的固定大小的数据项。每个数据项的长度和大小都是在创建队列时设置的。  img">
<meta property="og:type" content="article">
<meta property="og:title" content="FreeRTOS中队列(Queue)">
<meta property="og:url" content="http://example.com/2023/10/05/FreeRTOS%E4%B8%AD%E9%98%9F%E5%88%97(Queue)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="在Free RTOS中，队列是任务间通信的主要形式。它们可以用于在任务之间、中断和任务之间发送消息。下面来看看队列的相关内容。 队列特性  数据存储（Data Storage）  队列通常用作先进先出（FIFO）缓冲区，其中数据被写入队列的末尾（尾部），并从队列的前端（头部）移除。队列可以容纳有限数量（长度）的固定大小的数据项。每个数据项的长度和大小都是在创建队列时设置的。  img">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/queue_animation.gif">
<meta property="og:image" content="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/image-20231009173229604.png">
<meta property="og:image" content="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/image-20231009165541823.png">
<meta property="article:published_time" content="2023-10-05T13:46:36.000Z">
<meta property="article:modified_time" content="2023-10-11T10:02:02.656Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="queue">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/queue_animation.gif">
  
  
  
  

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"✍","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":false,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>

<meta name="referrer" content="no-referrer" />

<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>My Tech Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/article.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.1)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">FreeRTOS中队列(Queue)</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-10-05 21:46" pubdate>
          2023年10月5日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          26 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-12 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">FreeRTOS中队列(Queue)</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2023年10月11日 晚上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>在Free RTOS中，队列是任务间通信的主要形式。它们可以用于在任务之间、中断和任务之间发送消息。下面来看看队列的相关内容。</p>
<h1 id="队列特性">队列特性</h1>
<ol type="1">
<li><strong>数据存储（Data Storage）</strong></li>
</ol>
<p>队列通常用作先进先出（FIFO）缓冲区，其中数据被写入队列的末尾（尾部），并从队列的前端（头部）移除。队列可以容纳有限数量（长度）的固定大小的数据项。每个数据项的长度和大小都是在创建队列时设置的。</p>
<figure>
<img src="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/queue_animation.gif" srcset="/img/loading.gif" lazyload alt="" /><figcaption>img</figcaption>
</figure>
<p>上图展示创建的队列可容纳5个项目，Task A向队列中写入数据，Task B从队列中读取数据，队列中数据被读取后就会被删除，头部就会指向下一个数据。</p>
<p>队列中数据传输有两种方式：</p>
<ul>
<li><strong>拷贝</strong>：把数据、把变量的值复制进队列里</li>
<li><strong>引用</strong>：把数据、把变量的地址复制进队列里</li>
</ul>
<p>在FreeRTOS中，使用的是拷贝方式进行队列数据传输，这是因为：</p>
<ul>
<li>局部变量的值可直接送入队列，后续即使函数退出、局部变量被回收，也不会影响队列中的数据</li>
<li>无需分配缓冲区来保存数据，队列中有 buffer</li>
<li>局部变量可以立即再次使用</li>
<li>发送任务、接收任务解耦：不用关心哪个任务有数据，哪个任务释放数据</li>
<li>如果数据实在太大，你还是可以使用队列传输它的地址</li>
<li>FreeRTOS 负责分配队列的数据存储空间</li>
<li>在内存保护系统中，任务可访问的内存将受到限制。在这种情况下，只有当发送和接收任务都可以访问存储数据的内存时，才能使用队列应用。而队列拷贝并没有这种限制，内核有足够权限，允许使用队列跨内存保护边界传递数据。</li>
</ul>
<ol start="2" type="1">
<li><strong>可被多个任务访问 （Access by Multiple Tasks）</strong></li>
</ol>
<p>只要知道队列的句柄，任何任务或中断就能访问该队列，多个任务可以对同一个队列进行读写操作。多个任务对同一个队列写操作的情况很常见，但多个任务对同一个队列读操作的情况很少见。</p>
<ol start="3" type="1">
<li><strong>队列阻塞（Blocking on Queues）</strong></li>
</ol>
<p>当任务从队列中读操作时，可以指定阻塞时间。当队列为空，则任务进入阻塞状态，一旦队列中有数据，该任务会自动进入就绪态。如果阻塞时间超时，则任务也会进入就绪态。多个任务可对一个队列读操作，因此多个任务会对一个队列阻塞等待数据的到来，这种情况下，当数据到来时，只有一个任务会处于非阻塞态，且该任务具有最高优先级。如果所有阻塞态的任务具有相同的优先级，则等待数据时间最长的任务退出阻塞态。</p>
<p>同理，当任务从队列中写操作时，也可以指定阻塞时间。这个阻塞时间是指如果队列已满，任务保持在阻塞态以等待队列上有可用空间的最长时间。多个任务可对一个队列写操作，因此多个任务会对一个满队列阻塞等待数据的发送，在这种情况下，当队列上有可用空间，只有一个任务处于非阻塞态，且该任务具有最高优先级。如果所有阻塞态的任务具有相同的优先级，则等待空间最长时间的任务将退出阻塞态。</p>
<h1 id="队列常用api函数">队列常用API函数</h1>
<p>Free RTOS中，队列的常用API函数有：</p>
<ul>
<li><strong>创建队列</strong></li>
</ul>
<div class="code-wrapper"><pre><code class="hljs c">QueueHandle_t <span class="hljs-title function_">xQueueCreate</span><span class="hljs-params">( </span>
<span class="hljs-params">  									UBaseType_t uxQueueLength, <span class="hljs-comment">/* 队列长度 */</span></span>
<span class="hljs-params">  									UBaseType_t uxItemSize      <span class="hljs-comment">/* 每个队列项的数据大小 */</span></span>
<span class="hljs-params">                   )</span>;
QueueHandle_t <span class="hljs-title function_">xQueueCreateStatic</span><span class="hljs-params">(</span>
<span class="hljs-params">							  UBaseType_t uxQueueLength, <span class="hljs-comment">/* 队列长度 */</span></span>
<span class="hljs-params">							  UBaseType_t uxItemSize, <span class="hljs-comment">/* 每个队列项的数据大小 */</span></span>
<span class="hljs-params">							  <span class="hljs-type">uint8_t</span> *pucQueueStorageBuffer, <span class="hljs-comment">/* uint8_t[uxQueueLength * 			                                                      uxItemsSize ] */</span></span>
<span class="hljs-params">							  StaticQueue_t *pxQueueBuffer<span class="hljs-comment">/* 队列数据缓冲区 */</span></span>
<span class="hljs-params">						  )</span>;</code></pre></div>
<ul>
<li><strong>发送数据</strong></li>
</ul>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* 常规方式 */</span>
BaseType_t <span class="hljs-title function_">xQueueSendToFront</span><span class="hljs-params">( </span>
<span class="hljs-params">  										QueueHandle_t xQueue, <span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">                      <span class="hljs-type">const</span> <span class="hljs-type">void</span> * pvItemToQueue, <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">                      TickType_t xTicksToWait  <span class="hljs-comment">/* 阻塞态的最大时间(TickCount) */</span></span>
<span class="hljs-params">                     )</span>;
BaseType_t <span class="hljs-title function_">xQueueSendToBack</span><span class="hljs-params">( </span>
<span class="hljs-params">  										QueueHandle_t xQueue, <span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">                      <span class="hljs-type">const</span> <span class="hljs-type">void</span> * pvItemToQueue, <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">                      TickType_t xTicksToWait  <span class="hljs-comment">/* 阻塞态的最大时间(TickCount) */</span></span>
<span class="hljs-params">                     )</span>;
<span class="hljs-comment">/* 中断方式 */</span>
BaseType_t <span class="hljs-title function_">xQueueSendToFrontFromISR</span><span class="hljs-params">(</span>
<span class="hljs-params">										 QueueHandle_t xQueue, <span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">										 <span class="hljs-type">const</span> <span class="hljs-type">void</span> *pvItemToQueue, <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">										 BaseType_t *pxHigherPriorityTaskWoken <span class="hljs-comment">/* 是否唤醒其它任务的指针 */</span></span>
<span class="hljs-params">									  )</span>;
BaseType_t <span class="hljs-title function_">xQueueSendToBackFromISR</span><span class="hljs-params">(</span>
<span class="hljs-params">										 QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">										 <span class="hljs-type">const</span> <span class="hljs-type">void</span> *pvItemToQueue, <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">										 BaseType_t *pxHigherPriorityTaskWoken<span class="hljs-comment">/* 是否唤醒其它任务的指针 */</span></span>
<span class="hljs-params">									  )</span>;
<span class="hljs-comment">/* 单个数据的队列 */</span>
BaseType_t <span class="hljs-title function_">xQueueOverwrite</span><span class="hljs-params">(</span>
<span class="hljs-params">							  QueueHandle_t xQueue, <span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">							  <span class="hljs-type">const</span> <span class="hljs-type">void</span> * pvItemToQueue <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">						 )</span>;
BaseType_t <span class="hljs-title function_">xQueueOverwriteFromISR</span><span class="hljs-params">(</span>
<span class="hljs-params">							  QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">							  <span class="hljs-type">const</span> <span class="hljs-type">void</span> * pvItemToQueue,<span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">							  BaseType_t *pxHigherPriorityTaskWoken <span class="hljs-comment">/* 是否唤醒其它任务的指针 */</span></span>
<span class="hljs-params">						 )</span>;</code></pre></div>
<ul>
<li><strong>接收数据</strong></li>
</ul>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* 成功接收数据后，数据从队列删除 */</span>
BaseType_t <span class="hljs-title function_">xQueueReceive</span><span class="hljs-params">( </span>
<span class="hljs-params">                  QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">                  <span class="hljs-type">void</span> * <span class="hljs-type">const</span> pvBuffer,<span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">                  TickType_t xTicksToWait <span class="hljs-comment">/* 阻塞态的最大时间(TickCount) */</span></span>
<span class="hljs-params">                )</span>;
BaseType_t <span class="hljs-title function_">xQueueReceiveFromISR</span><span class="hljs-params">( </span>
<span class="hljs-params">                QueueHandle_t xQueue, <span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">                <span class="hljs-type">void</span> * <span class="hljs-type">const</span> pvBuffer, <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">                BaseType_t * <span class="hljs-type">const</span> pxHigherPriorityTaskWoken <span class="hljs-comment">/* 是否唤醒其它任务的指针 */</span> </span>
<span class="hljs-params">)</span>;
<span class="hljs-comment">/* 成功接收数据后，数据不从队列删除 */</span>
BaseType_t <span class="hljs-title function_">xQueuePeek</span><span class="hljs-params">(</span>
<span class="hljs-params">							 QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">							 <span class="hljs-type">void</span> * <span class="hljs-type">const</span> pvBuffer, <span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">							 TickType_t xTicksToWait <span class="hljs-comment">/* 阻塞态的最大时间(TickCount) */</span></span>
<span class="hljs-params">						 )</span>;
BaseType_t <span class="hljs-title function_">xQueuePeekFromISR</span><span class="hljs-params">(</span>
<span class="hljs-params">									QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">									<span class="hljs-type">void</span> *pvBuffer,<span class="hljs-comment">/* 数据指针 */</span></span>
<span class="hljs-params">								)</span>;</code></pre></div>
<ul>
<li><strong>删除队列、复位队列及其它</strong></li>
</ul>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vQueueDelete</span><span class="hljs-params">( QueueHandle_t xQueue )</span>;<span class="hljs-comment">/* 队列删除 */</span>
BaseType_t <span class="hljs-title function_">xQueueReset</span><span class="hljs-params">( xQueue )</span>;<span class="hljs-comment">/* 队列复位 */</span>
UBaseType_t <span class="hljs-title function_">uxQueueMessagesWaiting</span><span class="hljs-params">( <span class="hljs-type">const</span> QueueHandle_t xQueue )</span>;<span class="hljs-comment">/* 队列中的数据个数 */</span>
UBaseType_t <span class="hljs-title function_">uxQueueMessagesWaitingFromISR</span><span class="hljs-params">( <span class="hljs-type">const</span> QueueHandle_t xQueue )</span>;<span class="hljs-comment">/* 中断队列中的数据个数 */</span>
UBaseType_t <span class="hljs-title function_">uxQueueSpacesAvailable</span><span class="hljs-params">( <span class="hljs-type">const</span> QueueHandle_t xQueue )</span>;<span class="hljs-comment">/* 队列可用的空间 */</span></code></pre></div>
<p>通过队列阻塞接收数据示例代码：</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* sender function */</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vSenderTask</span><span class="hljs-params">( <span class="hljs-type">void</span> *pvParameters )</span>
&#123;
  <span class="hljs-type">int32_t</span> lValueToSend;
  BaseType_t xStatus;

  lValueToSend = ( <span class="hljs-type">int32_t</span> ) pvParameters;<span class="hljs-comment">/* 通过任务参数传递数据 */</span>

  <span class="hljs-keyword">for</span>( ;; )
  &#123;
    xStatus = xQueueSendToBack( xQueue, &amp;lValueToSend, <span class="hljs-number">0</span> );
    <span class="hljs-keyword">if</span>( xStatus != pdPASS )
    &#123;
    	<span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;Could not send to the queue.\r\n&quot;</span> );
    &#125;
  &#125;
&#125;
<span class="hljs-comment">/* reveiver function with blocking */</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vReceiverTask</span><span class="hljs-params">( <span class="hljs-type">void</span> *pvParameters )</span>
&#123;
  <span class="hljs-type">int32_t</span> lReceivedValue;
  BaseType_t xStatus;
  <span class="hljs-type">const</span> TickType_t xTicksToWait = pdMS_TO_TICKS( <span class="hljs-number">100</span> ); <span class="hljs-comment">/* 转换ms到tick*/</span>

  <span class="hljs-keyword">for</span>( ;; )
  &#123;
    <span class="hljs-keyword">if</span>( uxQueueMessagesWaiting( xQueue ) != <span class="hljs-number">0</span> )
    &#123;
    	<span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;Queue should have been empty!\r\n&quot;</span> );
    &#125;
    xStatus = xQueueReceive( xQueue, &amp;lReceivedValue, xTicksToWait );
    <span class="hljs-keyword">if</span>( xStatus == pdPASS )
    &#123;
    	<span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;Received = &quot;</span>, lReceivedValue );
    &#125;
    <span class="hljs-keyword">else</span>
    &#123;
    	<span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;Could not receive from the queue.\r\n&quot;</span> );
    &#125;
  &#125;
&#125;
<span class="hljs-comment">/* main function */</span>
QueueHandle_t xQueue;
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">( <span class="hljs-type">void</span> )</span>
&#123;
  <span class="hljs-comment">/* 创建一个队列 */</span>
  xQueue = xQueueCreate( <span class="hljs-number">5</span>, <span class="hljs-keyword">sizeof</span>( <span class="hljs-type">int32_t</span> ) );
  <span class="hljs-keyword">if</span>( xQueue != <span class="hljs-literal">NULL</span> )
  &#123;
    <span class="hljs-comment">/* 创建两个发送任务和一个接收任务，接收优先级更高 */</span>
    xTaskCreate( vSenderTask, <span class="hljs-string">&quot;Sender1&quot;</span>, <span class="hljs-number">1000</span>, ( <span class="hljs-type">void</span> * ) <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span> );
    xTaskCreate( vSenderTask, <span class="hljs-string">&quot;Sender2&quot;</span>, <span class="hljs-number">1000</span>, ( <span class="hljs-type">void</span> * ) <span class="hljs-number">200</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span> );
    xTaskCreate( vReceiverTask, <span class="hljs-string">&quot;Receiver&quot;</span>, <span class="hljs-number">1000</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">NULL</span> );

    vTaskStartScheduler(); <span class="hljs-comment">/* 启动任务调度器 */</span>
  &#125;
  <span class="hljs-keyword">for</span>( ;; );
&#125;</code></pre></div>
<figure>
<img src="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/image-20231009173229604.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image-20231009173229604</figcaption>
</figure>
<h1 id="接收多任务数据-multiple-sources">接收多任务数据 Multiple Sources</h1>
<p>通过队列阻塞发送结构体数据，示例代码如下：</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span></span>
<span class="hljs-class">&#123;</span>
  eSender1,
  eSender2
&#125; DataSource_t;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span>
<span class="hljs-class">&#123;</span>
  <span class="hljs-type">uint8_t</span> ucValue;
  DataSource_t eDataSource;
&#125; Data_t;
<span class="hljs-comment">/* 声明一个结构体变量数组 */</span>
<span class="hljs-type">static</span> <span class="hljs-type">const</span> Data_t xStructsToSend[ <span class="hljs-number">2</span> ] =
&#123;
  &#123; <span class="hljs-number">100</span>, eSender1 &#125;, <span class="hljs-comment">/* Used by Sender1. */</span>
  &#123; <span class="hljs-number">200</span>, eSender2 &#125; <span class="hljs-comment">/* Used by Sender2. */</span>
&#125;;

<span class="hljs-comment">/* sender function */</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vSenderTask</span><span class="hljs-params">( <span class="hljs-type">void</span> *pvParameters )</span>
&#123;
  BaseType_t xStatus;
  <span class="hljs-type">const</span> TickType_t xTicksToWait = pdMS_TO_TICKS( <span class="hljs-number">100</span> );
  <span class="hljs-keyword">for</span>( ;; )
  &#123;
    xStatus = xQueueSendToBack( xQueue, pvParameters, xTicksToWait );
    <span class="hljs-keyword">if</span>( xStatus != pdPASS )
    &#123;
    	<span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;Could not send to the queue.\r\n&quot;</span> );
    &#125;
  &#125;
&#125;
<span class="hljs-comment">/* receiver function */</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vReceiverTask</span><span class="hljs-params">( <span class="hljs-type">void</span> *pvParameters )</span>
&#123;
  Data_t xReceivedStructure;
  BaseType_t xStatus;
  <span class="hljs-keyword">for</span>( ;; )
  &#123;
    <span class="hljs-keyword">if</span>( uxQueueMessagesWaiting( xQueue ) != <span class="hljs-number">3</span> )
    &#123;
    	pintf( <span class="hljs-string">&quot;Queue should have been full!\r\n&quot;</span> );
    &#125;
    xStatus = xQueueReceive( xQueue, &amp;xReceivedStructure, <span class="hljs-number">0</span> );
    <span class="hljs-keyword">if</span>( xStatus == pdPASS )
    &#123;
      <span class="hljs-keyword">if</span>( xReceivedStructure.eDataSource == eSender1 )
      &#123;
        <span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;From Sender 1 = &quot;</span>, xReceivedStructure.ucValue );
      &#125;
      <span class="hljs-keyword">else</span>
      &#123;
        <span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;From Sender 2 = &quot;</span>, xReceivedStructure.ucValue );
      &#125;
    &#125;
    <span class="hljs-keyword">else</span>
    &#123;
      <span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;Could not receive from the queue.\r\n&quot;</span> );
    &#125;
  &#125;
&#125;
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">( <span class="hljs-type">void</span> )</span>
&#123;
  <span class="hljs-comment">/* 创建一个队列 */</span>
  xQueue = xQueueCreate( <span class="hljs-number">3</span>, <span class="hljs-keyword">sizeof</span>( Data_t ) );
  <span class="hljs-keyword">if</span>( xQueue != <span class="hljs-literal">NULL</span> )
  &#123;
    <span class="hljs-comment">/* 创建三个任务 */</span>
    xTaskCreate( vSenderTask, <span class="hljs-string">&quot;Sender1&quot;</span>, <span class="hljs-number">1000</span>, &amp;( xStructsToSend[ <span class="hljs-number">0</span> ] ), <span class="hljs-number">2</span>, <span class="hljs-literal">NULL</span> );
    xTaskCreate( vSenderTask, <span class="hljs-string">&quot;Sender2&quot;</span>, <span class="hljs-number">1000</span>, &amp;( xStructsToSend[ <span class="hljs-number">1</span> ] ), <span class="hljs-number">2</span>, <span class="hljs-literal">NULL</span> );
    xTaskCreate( vReceiverTask, <span class="hljs-string">&quot;Receiver&quot;</span>, <span class="hljs-number">1000</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span> );
    vTaskStartScheduler();
  &#125;
  <span class="hljs-keyword">for</span>( ;; );
&#125;</code></pre></div>
<figure>
<img src="https://gitee.com/kayoungzhang/picgo_res/raw/master/img/image-20231009165541823.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image-20231009165541823</figcaption>
</figure>
<h1 id="传输大量数据">传输大量数据</h1>
<p>使用队列可以发送不同类型的数据和不同长度的数据，当队列传输数据量较大时，使用数据指针传输更有效，使用时需要注意：</p>
<ul>
<li><strong>被指向的内存要明确定义。</strong></li>
</ul>
<p>当任务间通过指针共享内存时，需要保证两个任务不能同时修改内存内容，或其它导致内存的内容出错的动作。理想的情况下，在写队列之前只能由发送任务访问这块内存，在读队列之后只能由接收任务访问这块内存。</p>
<ul>
<li><strong>被指向的内存要有效</strong></li>
</ul>
<p>如果被指向的内存是动态分配的或从预分配缓冲池中分配的，那么就必须有个任务要去释放内存，释放后的内存，是不能访问的。</p>
<p>不要使用任务栈上分配的指针访问数据，因为栈改变后，数据就会无效。</p>
<h1 id="从多个队列接收数据">从多个队列接收数据</h1>
<p>前面展示了使用单个接收结构体的队列任务接收不同大小、不同含义和不同来源的数据。但有时限制的条件下，需要使用单独的队列来传输某些数据源。例如，将第三方代码集成到设计中就要用专用队列，这时“队列集”就派上用场了。</p>
<p><strong>队列集</strong> 允许任务从多个队列中接收数据，而无需依次轮询以确定哪个队列包含数据。</p>
<p>使用队列集从多个来源接收数据的设计，与使用单个接收结构体队列来实现同样功能的设计相比，会不整洁，效率也更低，建议仅在约束条件时需要使用到队列集的设计才使用队列集。</p>
<p>队列集中使用的函数主要有：</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* 创建队列集 */</span>
QueueSetHandle_t <span class="hljs-title function_">xQueueCreateSet</span><span class="hljs-params">( </span>
<span class="hljs-params">  <span class="hljs-type">const</span> UBaseType_t uxEventQueueLength <span class="hljs-comment">/* 队列集中队列句柄的数目 */</span></span>
<span class="hljs-params">)</span>;
<span class="hljs-comment">/* 把队列或信号量添加到队列集中 */</span>
BaseType_t <span class="hljs-title function_">xQueueAddToSet</span><span class="hljs-params">( </span>
<span class="hljs-params">  QueueSetMemberHandle_t xQueueOrSemaphore, <span class="hljs-comment">/* 被添加的队列或信号量句柄 */</span></span>
<span class="hljs-params">  QueueSetHandle_t xQueueSet <span class="hljs-comment">/* 队列集句柄 */</span></span>
<span class="hljs-params">)</span>;
<span class="hljs-comment">/* 读取队列集中队列句柄 */</span>
QueueSetMemberHandle_t <span class="hljs-title function_">xQueueSelectFromSet</span><span class="hljs-params">( </span>
<span class="hljs-params">  QueueSetHandle_t xQueueSet, <span class="hljs-comment">/* 被读取的队列集句柄 */</span></span>
<span class="hljs-params">  <span class="hljs-type">const</span> TickType_t xTicksToWait <span class="hljs-comment">/* 阻塞的最大等待时间 */</span></span>
<span class="hljs-params">)</span>;  
<span class="hljs-comment">/* 中断方式读取队列集中队列句柄 */</span>
QueueSetMemberHandle_t <span class="hljs-title function_">xQueueSelectFromSetFromISR</span><span class="hljs-params">( </span>
<span class="hljs-params">  QueueSetHandle_t xQueueSet <span class="hljs-comment">/* 被读取的队列集句柄 */</span></span>
<span class="hljs-params">)</span>;</code></pre></div>
<h1 id="使用队列创建邮箱">使用队列创建邮箱</h1>
<p>不同的RTOS，邮箱指的是不同的事物，这里指 <strong>长度为1的队列</strong>。</p>
<p>队列用于将数据从一个任务发送到另一个任务，或从中断中发送到一个任务。发送方将一个项目放入队列，接收方从队列中删除该项目，这样数据通过队列就从发送方传递到接收方了。</p>
<p>邮箱用于保存由任何任务或任何中断读取的数据。数据一直保留在邮箱中，直到被覆盖。发送方重写邮箱中的值。接收方从邮箱中读取该值，但不会删除它。</p>
<p>邮箱API函数：</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* 发送一个数据项到邮箱 */</span>
BaseType_t <span class="hljs-title function_">xQueueOverwrite</span><span class="hljs-params">(</span>
<span class="hljs-params">QueueHandle_t xQueue, <span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-type">void</span> * pvItemToQueue <span class="hljs-comment">/* 被发送数据项的指针 */</span></span>
<span class="hljs-params">)</span>;
<span class="hljs-comment">/* 中断模式下，发送一个数据项到邮箱 */</span>
BaseType_t <span class="hljs-title function_">xQueueOverwriteFromISR</span><span class="hljs-params">(</span>
<span class="hljs-params">  QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">  <span class="hljs-type">const</span> <span class="hljs-type">void</span> * pvItemToQueue,<span class="hljs-comment">/* 被发送数据项的指针 */</span></span>
<span class="hljs-params">  BaseType_t *pxHigherPriorityTaskWoken <span class="hljs-comment">/* 唤醒高优先级任务 */</span></span>
<span class="hljs-params">)</span>;
<span class="hljs-comment">/* 从邮箱中读取一个数据项 */</span>
BaseType_t <span class="hljs-title function_">xQueuePeek</span><span class="hljs-params">(</span>
<span class="hljs-params">  QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">  <span class="hljs-type">void</span> * <span class="hljs-type">const</span> pvBuffer,<span class="hljs-comment">/* 被读取数据项的缓存指针 */</span></span>
<span class="hljs-params">  TickType_t xTicksToWait<span class="hljs-comment">/* 任务阻塞等待的最长时间 */</span></span>
<span class="hljs-params">)</span>;
<span class="hljs-comment">/* 中断模式下，从邮箱中读取一个数据项 */</span>
BaseType_t <span class="hljs-title function_">xQueuePeekFromISR</span><span class="hljs-params">(</span>
<span class="hljs-params">  QueueHandle_t xQueue,<span class="hljs-comment">/* 队列句柄 */</span></span>
<span class="hljs-params">  <span class="hljs-type">void</span> *pvBuffer,<span class="hljs-comment">/* 被读取数据项的缓存指针 */</span></span>
<span class="hljs-params">)</span>;</code></pre></div>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/RTOS/" class="category-chain-item">RTOS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/queue/">#queue</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/10/05/FreeRTOS%E4%B8%AD%E4%BF%A1%E5%8F%B7%E9%87%8F(Semaphore)/" title="FreeRTOS中信号量(Semaphore)">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">FreeRTOS中信号量(Semaphore)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/10/05/FreeRTOS%E4%B8%AD%E4%BB%BB%E5%8A%A1(Task)/" title="FreeRTOS中任务(Task)">
                        <span class="hidden-mobile">FreeRTOS中任务(Task)</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"vknpQgHbpd1oLUPUwwPbdY3B-gzGzoHsz","appKey":"1DCiNflrxTVqUxWR5T00HypH","path":"window.location.pathname","placeholder":"欢迎留言交流","avatar":"robohash","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":true,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <p <i class="iconfont icon-copyright"></i> <span>2023 | KayougZhang</span> </p> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
